<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盈亏平衡分析 (BEA) 专项工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 350px; 
            margin-bottom: 2rem;
        }
        .input-group label { transition: all 0.2s ease; }
        .input-group:focus-within label { color: #1E40AF; font-weight: 600; }
        /* Style for the financial table */
        #projectionTable th { background-color: #EBF4FF; color: #1E40AF; text-align: right; padding: 0.5rem; }
        #projectionTable td { text-align: right; padding: 0.5rem; border-bottom: 1px solid #E5E7EB; }
        .profit { color: #10B981; font-weight: 600; }
        .loss { color: #EF4444; font-weight: 600; }
        .text-cny { font-size: 0.8em; margin-right: 2px; }
    </style>
</head>
<body class="text-gray-800 p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10 border-t-8 border-blue-700">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900">盈亏平衡分析 (BEA) 专项工具</h1>
            <p class="text-gray-500 mt-2">评估您的商业模式能否覆盖成本并实现盈利</p>
        </header>

        <!-- 概念讲解 (Conceptual Explanation) -->
        <section class="mb-10 p-6 bg-blue-50 rounded-lg border border-blue-200">
            <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">核心概念与公式</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <strong class="text-blue-700">1. 固定成本 (FC):</strong> 无论生产或销售多少产品，都必须支付的成本（如租金、管理人员工资）。
                </div>
                <div>
                    <strong class="text-blue-700">2. 单位变动成本 (VC):</strong> 生产每增加一个单位产品所增加的成本（如原材料、直接人工）。
                </div>
                <div>
                    <strong class="text-blue-700">3. 单价 (P):</strong> 每个产品或服务卖出的价格。
                </div>
                <div>
                    <strong class="text-blue-700">4. 贡献毛利 (CM):</strong> 贡献毛利 $=$ 单价 $-$ 单位变动成本。每卖出一个单位产品，能为企业贡献多少利润来覆盖固定成本。
                </div>
            </div>
            <div class="mt-4 text-center p-3 bg-blue-100 rounded">
                <strong class="text-lg text-blue-900">盈亏平衡点 (BEP) 公式:</strong>
                <p class="mt-1 text-xl font-mono text-gray-700">
                    BEP (单位数量) = 固定成本 / 贡献毛利
                </p>
            </div>
        </section>

        <!-- 互动输入区 (Interactive Input Area) -->
        <section class="mb-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 p-6 bg-gray-50 rounded-lg shadow-md space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2">输入您的财务参数</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="fixedCost" class="block text-sm font-medium text-gray-700">年度固定成本 (￥):</label>
                        <input type="number" id="fixedCost" value="120000" min="1" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="input-group">
                        <label for="price" class="block text-sm font-medium text-gray-700">产品或服务单价 (￥/单位):</label>
                        <input type="number" id="price" value="50" min="1" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="input-group">
                        <label for="variableCost" class="block text-sm font-medium text-gray-700">单位变动成本 (￥/单位):</label>
                        <input type="number" id="variableCost" value="20" min="0" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="input-group">
                        <label for="growthRate" class="block text-sm font-medium text-gray-700">月销售量增长率 (%):</label>
                        <input type="number" id="growthRate" value="10" min="0" max="100" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div class="input-group">
                        <label for="startVolume" class="block text-sm font-medium text-gray-700">首月销售数量 (单位):</label>
                        <input type="number" id="startVolume" value="2000" min="0" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" />
                    </div>
                </div>
                <button id="calculateBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300 mt-4">
                    立即计算 & 12个月预测
                </button>
            </div>

            <!-- 核心结果 (Core Results) -->
            <div id="resultsPanel" class="p-6 bg-green-50 rounded-lg shadow-xl flex flex-col justify-between border-l-4 border-green-500">
                <div>
                    <h2 class="text-xl font-bold text-green-700 mb-4">核心 BEP 结果</h2>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">贡献毛利 (单位):</p>
                        <p class="text-2xl font-extrabold text-blue-900"><span id="cmValue">30</span> ￥/单位</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">盈亏平衡点 (BEP) 销售量:</p>
                        <p class="text-3xl font-extrabold text-orange-600"><span id="bepUnitsValue">4,000</span> 单位</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">盈亏平衡点 (BEP) 销售额:</p>
                        <p class="text-3xl font-extrabold text-orange-600"><span id="bepRevenueValue">200,000</span> ￥</p>
                    </div>
                </div>
                <div id="statusMessage" class="mt-4 p-2 text-sm rounded-md bg-green-100 text-green-800">
                    <strong class="font-semibold">分析状态:</strong> 良好，贡献毛利为正。
                </div>
            </div>
        </section>

        <!-- BEP 标准图 (Standard BEP Chart) -->
        <section class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">标准盈亏平衡图</h2>
            <div class="chart-container bg-white p-4 rounded-lg shadow-inner">
                <canvas id="standardBepChart"></canvas>
            </div>
        </section>

        <!-- 12个月周期预测 (12-Month Projection) -->
        <section>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">12个月周期盈利预测</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 预测图表 -->
                <div class="chart-container bg-white p-4 rounded-lg shadow-inner">
                    <canvas id="monthlyProjectionChart"></canvas>
                </div>
                <!-- 预测表格 -->
                <div>
                    <div class="overflow-x-auto shadow-md rounded-lg">
                        <table id="projectionTable" class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th>月份</th>
                                    <th>销售量 (单位)</th>
                                    <th>总收入 (￥)</th>
                                    <th>总成本 (￥)</th>
                                    <th>净利润 (￥)</th>
                                </tr>
                            </thead>
                            <tbody id="projectionBody" class="bg-white divide-y divide-gray-200 text-sm">
                                <!-- Table rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div id="projectionSummary" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 text-sm text-blue-800">
                        <!-- Summary text will be inserted here -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- Global Chart Instances ---
        let standardBepChart = null;
        let monthlyProjectionChart = null;
        
        // --- Utility Functions ---
        
        /**
         * 格式化数字为货币格式 (CNY, 整数)
         * @param {number} num 
         * @returns {string} 
         */
        function formatCurrency(num) {
            // 使用中文货币格式，只保留整数部分
            return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', maximumFractionDigits: 0 }).format(num);
        }

        /**
         * 格式化数字为千分位
         * @param {number} num 
         * @returns {string} 
         */
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-CN').format(num);
        }

        // --- Core Calculation and Rendering ---

        function calculateAndRender() {
            // 1. 获取输入参数 (Get inputs)
            const fc = parseFloat(document.getElementById('fixedCost').value); // 年度固定成本
            const p = parseFloat(document.getElementById('price').value); // 单价
            const vc = parseFloat(document.getElementById('variableCost').value); // 单位变动成本
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100; // 月销售量增长率
            const startVolume = parseFloat(document.getElementById('startVolume').value); // 首月销售数量
            
            const resultsPanel = document.getElementById('resultsPanel');
            const statusMessage = document.getElementById('statusMessage');

            // 2. 验证输入 (Input Validation)
            if (isNaN(fc) || isNaN(p) || isNaN(vc) || isNaN(growthRate) || isNaN(startVolume) || p <= 0 || fc < 0 || vc < 0) {
                resultsPanel.className = 'p-6 bg-red-50 rounded-lg shadow-xl flex flex-col justify-between border-l-4 border-red-500';
                statusMessage.className = 'mt-4 p-2 text-sm rounded-md bg-red-100 text-red-800';
                statusMessage.innerHTML = '<strong class="font-semibold">错误:</strong> 请输入所有有效的非负数字。';
                return;
            }

            // 3. 计算贡献毛利 (Calculate Contribution Margin)
            const cm = p - vc;
            document.getElementById('cmValue').textContent = formatNumber(cm);
            
            if (cm <= 0) {
                // 无法盈利的警告 (Warning for impossibility)
                resultsPanel.className = 'p-6 bg-yellow-50 rounded-lg shadow-xl flex flex-col justify-between border-l-4 border-yellow-500';
                document.getElementById('bepUnitsValue').textContent = '无法平衡';
                document.getElementById('bepRevenueValue').textContent = '无法平衡';
                statusMessage.className = 'mt-4 p-2 text-sm rounded-md bg-yellow-100 text-yellow-800';
                statusMessage.innerHTML = '<strong class="font-semibold">警告:</strong> 贡献毛利 (单价-变动成本) 为零或负数，企业无法盈利。请调整价格或降低成本。';
                if (standardBepChart) standardBepChart.destroy();
                if (monthlyProjectionChart) monthlyProjectionChart.destroy();
                document.getElementById('projectionBody').innerHTML = '';
                document.getElementById('projectionSummary').innerHTML = '无法进行预测，请修正输入参数。';
                return;
            }

            // 恢复正常状态 (Restore normal status)
            resultsPanel.className = 'p-6 bg-green-50 rounded-lg shadow-xl flex flex-col justify-between border-l-4 border-green-500';
            statusMessage.className = 'mt-4 p-2 text-sm rounded-md bg-green-100 text-green-800';
            statusMessage.innerHTML = '<strong class="font-semibold">分析状态:</strong> 成功计算，您的模式可行。';
            
            // 4. 计算 BEP (Calculate BEP)
            const bepUnits = Math.ceil(fc / cm);
            const bepRevenue = bepUnits * p;

            document.getElementById('bepUnitsValue').textContent = formatNumber(bepUnits);
            document.getElementById('bepRevenueValue').textContent = formatCurrency(bepRevenue);
            
            // --- Step 5: 渲染标准 BEP 图表 (Render Standard BEP Chart) ---
            renderStandardBepChart(fc, p, vc, bepUnits);

            // --- Step 6: 渲染 12 个月预测 (Render 12-Month Projection) ---
            renderMonthlyProjection(fc, p, vc, growthRate, startVolume, bepUnits);
        }

        /**
         * 渲染标准盈亏平衡图 (总成本 vs. 总收入)
         */
        function renderStandardBepChart(fc, p, vc, bepUnits) {
            const ctx = document.getElementById('standardBepChart').getContext('2d');
            
            // 确保图表范围覆盖 BEP 的 150%
            const maxUnits = Math.max(bepUnits * 1.5, 10000); 
            const steps = 10;
            const unitStep = Math.ceil(maxUnits / steps / 1000) * 1000; // Round up to nearest thousand for labels

            const volumes = [0, bepUnits]; // 确保 0 和 BEP 点被包含
            for (let i = 1; i <= steps; i++) {
                const vol = i * unitStep;
                if (!volumes.includes(vol)) volumes.push(vol);
            }
            volumes.sort((a, b) => a - b);
            const uniqueVolumes = [...new Set(volumes)];
            
            // 计算成本和收入数据
            const totalCosts = uniqueVolumes.map(u => fc + (u * vc));
            const revenue = uniqueVolumes.map(u => u * p);

            if (standardBepChart) standardBepChart.destroy();
            
            standardBepChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: uniqueVolumes.map(u => formatNumber(u) + ' 单位'),
                    datasets: [
                        {
                            label: '总成本 (Total Cost)',
                            data: totalCosts,
                            borderColor: '#F97316', // 橙色
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointRadius: 2,
                            tension: 0.1
                        },
                        {
                            label: '总收入 (Revenue)',
                            data: revenue,
                            borderColor: '#1E40AF', // 蓝色
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointRadius: 2,
                            tension: 0.1
                        },
                        {
                            label: '固定成本 (Fixed Cost)',
                            data: uniqueVolumes.map(() => fc),
                            borderColor: '#9CA3AF', 
                            borderDash: [5, 5],
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '销售量 vs. 成本与收入图'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    // 显示货币符号
                                    label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '金额 (￥)' },
                            // 格式化 Y 轴标签
                            ticks: { callback: (value) => formatCurrency(value, 0).replace('￥', '') }
                        },
                        x: {
                            title: { display: true, text: '销售数量 (单位)' }
                        }
                    },
                    annotation: {
                        annotations: [{
                            type: 'point',
                            xValue: bepUnits,
                            yValue: bepUnits * p,
                            radius: 8,
                            backgroundColor: '#10B981',
                            label: {
                                enabled: true,
                                content: 'BEP (盈亏平衡点)',
                                position: 'end'
                            }
                        }]
                    }
                }
            });
        }

        /**
         * 渲染 12 个月周期预测表和图表
         */
        function renderMonthlyProjection(fc, p, vc, growthRate, startVolume, bepUnits) {
            const monthlyFC = fc / 12; // 月度固定成本
            const months = 12;
            const labels = [];
            const profits = [];
            const monthlyVolumes = [];
            
            let bepMonth = -1;
            let currentVolume = startVolume;

            document.getElementById('projectionBody').innerHTML = ''; // 清空表格内容
            
            for (let i = 1; i <= months; i++) {
                labels.push(`第 ${i} 月`);
                
                // 确保销售量为整数
                const salesVolume = Math.round(currentVolume);
                monthlyVolumes.push(salesVolume);

                const totalRevenue = salesVolume * p;
                const totalVC = salesVolume * vc;
                const totalCost = monthlyFC + totalVC;
                const netProfit = totalRevenue - totalCost;

                profits.push(netProfit);

                // 检查是否达到 BEP
                if (bepMonth === -1 && netProfit >= 0) {
                    bepMonth = i;
                }

                // 渲染表格行
                const tr = document.createElement('tr');
                const profitClass = netProfit >= 0 ? 'profit' : 'loss';
                
                // 使用中文符号和千分位格式
                tr.innerHTML = `
                    <td class="font-semibold">${i}</td>
                    <td>${formatNumber(salesVolume)}</td>
                    <td><span class="text-cny">￥</span>${formatNumber(totalRevenue)}</td>
                    <td><span class="text-cny">￥</span>${formatNumber(totalCost)}</td>
                    <td class="${profitClass}"><span class="text-cny">￥</span>${formatNumber(netProfit)}</td>
                `;
                document.getElementById('projectionBody').appendChild(tr);

                // 应用月增长率
                currentVolume *= (1 + growthRate);
            }
            
            // 渲染总结 (Render Summary)
            let summaryText = `根据当前的 ${formatNumber(growthRate * 100)}% 月销售增长率和首月 ${formatNumber(startVolume)} 单位销售量，`;
            if (bepMonth !== -1) {
                summaryText += `您的企业预计将在 <strong class="text-orange-600">第 ${bepMonth} 个月</strong> 达到盈亏平衡点并开始盈利。`;
            } else {
                summaryText += `在 12 个月内，您的企业<strong class="text-red-600">未能达到</strong>盈亏平衡点。您需要更快的增长或更低的成本。`;
            }
            document.getElementById('projectionSummary').innerHTML = summaryText;

            // 渲染图表 (Render Chart)
            const ctx = document.getElementById('monthlyProjectionChart').getContext('2d');
            if (monthlyProjectionChart) monthlyProjectionChart.destroy();

            monthlyProjectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '净利润 (Net Profit/Loss, ￥)',
                            data: profits,
                            borderColor: profits.map(p => p >= 0 ? '#10B981' : '#EF4444'),
                            backgroundColor: profits.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: '月销售量 (Units)',
                            data: monthlyVolumes,
                            borderColor: '#3B82F6',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 2,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '月度利润与销售量预测趋势' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('净利润')) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    } else {
                                        return context.dataset.label + ': ' + formatNumber(context.parsed.y) + ' 单位';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '净利润 (￥)' },
                            // 格式化 Y 轴标签
                            ticks: { callback: (value) => formatCurrency(value, 0).replace('￥', '') }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '销售量 (单位)' },
                            grid: { drawOnChartArea: false }, // Only draw grid lines for the left axis
                            ticks: { callback: (value) => formatNumber(value) }
                        }
                    }
                }
            });
        }

        // --- Initialization ---
        document.getElementById('calculateBtn').addEventListener('click', calculateAndRender);

        // Initial rendering when the page loads
        window.onload = calculateAndRender;

    </script>
</body>
</html>
